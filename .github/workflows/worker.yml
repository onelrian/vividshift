# .github/workflows/main.yml

name: Build and Deploy Docker Container

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 10 */14 * *' # Runs every 14 days at 10 AM UTC

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/work-group-generator:latest .
      
      - name: Run Docker Container and Capture Output
        run: |
          docker run --rm -v "$(pwd):/app" -w /app ghcr.io/${{ github.repository }}/work-group-generator:latest > output.txt
          echo "ğŸ” Checking output.txt:"
          cat output.txt || echo "âš ï¸ No content in output.txt"
          if [ ! -s output.txt ]; then
            echo "âŒ Error: output.txt is empty! Exiting."
            exit 1
          fi
      
      - name: Commit updated assignment history
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Update assignment history [skip ci]"
          file_pattern: assignment_history.json
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions Bot <actions@github.com>"
      
      - name: Upload Output as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: work-output
          path: output.txt
          retention-days: 1

  send-to-discord:
    needs: build-and-run
    runs-on: ubuntu-latest
    steps:
      - name: Download Output Artifact
        uses: actions/download-artifact@v4
        with:
          name: work-output
          path: .
      
      - name: Format and Send Discord Notification
        run: |
          # Filter for only the assignment lines
          grep 'â¡ï¸' output.txt > formatted_output.txt || true
          
          # Build fields JSON
          FIELDS_JSON=""
          while IFS= read -r line; do
            # Extract key/value
            key=$(echo "$line" | awk -F':' '{print $1}' | sed 's/â¡ï¸//' | xargs)
            value=$(echo "$line" | awk -F':' '{$1=""; print $0}' | xargs)
            
            case "$key" in
              "Tank")      icon="ğŸ›¢ï¸" ;;
              "Bin")       icon="ğŸ—‘ï¸" ;;
              "Frontyard") icon="ğŸšª" ;;
              "Toilet A")  icon="ğŸš»" ;;
              "Toilet B")  icon="ğŸš»" ;;
              "Backyard")  icon="ğŸ¡" ;;
              "Parlor")    icon="ğŸ›‹ï¸" ;;
              *)           icon="ğŸ”¹" ;;
            esac

            # Create JSON object for this field
            FIELD=$(jq -n --arg name "$icon $key" --arg value "Assigned: $value" \
              '{name: $name, value: $value, inline: false}')
            
            # Append with comma; will remove trailing comma later
            FIELDS_JSON+="$FIELD,"
          done < formatted_output.txt
          
          # If no lines matched (so FIELDS_JSON is empty), set to empty array
          if [ -z "$FIELDS_JSON" ]; then
            FIELDS_JSON="[]"
          else
            FIELDS_JSON="[${FIELDS_JSON%,}]"
          fi
          
          # Timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Build payload
          jq -n \
            --argjson fields "$FIELDS_JSON" \
            --arg timestamp "$TIMESTAMP" \
            '{
              "embeds": [
                {
                  "title": "ğŸ“Š Work Distribution Results",
                  "color": 5814783,
                  "timestamp": $timestamp,
                  "fields": $fields
                }
              ]
            }' > discord_payload.json
          
          echo "--- Generated Payload ---"
          cat discord_payload.json
          echo "-------------------------"
          
          # Send to Discord
          curl -X POST -H "Content-Type: application/json" \
            --fail --silent --show-error \
            -d @discord_payload.json \
            ${{ secrets.DISCORD_WEBHOOK }}
