name: Work Assignment Generator

# Default to manual/API triggering for efficiency.
# See README.md for scheduling options (external scheduler, cron, etc.)
on:
  workflow_dispatch: # Manual trigger
  # Uncomment for daily automated checks (less efficient):
  # schedule:
  #   - cron: '0 9 * * *' # Daily at 9 AM UTC

jobs:
  run-generator:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build and Run
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          APP__ASSIGNMENT_INTERVAL_DAYS: ${{ secrets.ASSIGNMENT_INTERVAL_DAYS || '14' }}
        run: |
          # The app checks if scheduled interval has passed.
          # It sets SHOULD_NOTIFY=true/false in GITHUB_ENV.
          cargo run --release > output.txt
          cat output.txt

      - name: Format and Send Discord Notification
        if: success() && env.SHOULD_NOTIFY == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          grep 'â¡ï¸' output.txt > formatted_output.txt || true
          
          FIELDS_JSON=""
          while IFS= read -r line; do
            key=$(echo "$line" | awk -F':' '{print $1}' | sed 's/â¡ï¸//' | xargs)
            value=$(echo "$line" | awk -F':' '{$1=""; print $0}' | xargs)
            
            case "$key" in
              "Tank")      icon="ğŸ›¢ï¸" ;;
              "Bin")       icon="ğŸ—‘ï¸" ;;
              "Frontyard") icon="ğŸšª" ;;
              "Toilet A")  icon="ğŸš»" ;;
              "Toilet B")  icon="ğŸš»" ;;
              "Backyard")  icon="ğŸ¡" ;;
              "Parlor")    icon="ğŸ›‹ï¸" ;;
              *)           icon="ğŸ”¹" ;;
            esac

            FIELD=$(jq -n --arg name "$icon $key" --arg value "Assigned: $value" \
              '{name: $name, value: $value, inline: false}')
            FIELDS_JSON+="$FIELD,"
          done < formatted_output.txt
          
          if [ -z "$FIELDS_JSON" ]; then
            echo "No fields parsed. Exiting."
            exit 0
          fi
          
          FIELDS_JSON="[${FIELDS_JSON%,}]"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          jq -n \
            --argjson fields "$FIELDS_JSON" \
            --arg timestamp "$TIMESTAMP" \
            '{
              "embeds": [
                {
                  "title": "ğŸ“Š Work Distribution Results",
                  "color": 5814783,
                  "timestamp": $timestamp,
                  "fields": $fields
                }
              ]
            }' > discord_payload.json
          
          curl -X POST -H "Content-Type: application/json" \
            --fail --silent --show-error \
            -d @discord_payload.json \
            $DISCORD_WEBHOOK
